import org.apache.hc.client5.http.classic.CloseableHttpClient;
import org.apache.hc.client5.http.classic.methods.HttpPost;
import org.apache.hc.client5.http.impl.classic.CloseableHttpResponse;
import org.apache.hc.client5.http.impl.classic.HttpClients;
import org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager;
import org.apache.hc.client5.http.ssl.ClientTlsStrategyBuilder;
import org.apache.hc.core5.http.io.entity.StringEntity;
import org.apache.hc.core5.ssl.SSLContextBuilder;
import org.apache.hc.core5.ssl.SSLContexts;

import javax.net.ssl.SSLContext;
import java.io.FileInputStream;
import java.security.KeyStore;

public class HttpClientPostSSL {

    public static void main(String[] args) throws Exception {

        // --- Load keystore ---
        KeyStore keyStore = KeyStore.getInstance("PKCS12");
        try (FileInputStream ks = new FileInputStream("client-keystore.p12")) {
            keyStore.load(ks, "changeit".toCharArray());
        }

        // --- Load truststore ---
        KeyStore trustStore = KeyStore.getInstance("JKS");
        try (FileInputStream ts = new FileInputStream("truststore.jks")) {
            trustStore.load(ts, "changeit".toCharArray());
        }

        // --- Build SSLContext ---
        SSLContext sslContext = SSLContexts.custom()
                .loadKeyMaterial(keyStore, "changeit".toCharArray())      // client certificate
                .loadTrustMaterial(trustStore, null)                     // server CA
                .build();

        // --- Build TLS strategy for HttpClient 5.2.x ---
        var tlsStrategy = ClientTlsStrategyBuilder.create()
                .setSslContext(sslContext)
                .build();

        // --- Build connection manager ---
        PoolingHttpClientConnectionManager cm =
                new PoolingHttpClientConnectionManager(tlsStrategy);

        // --- Build HttpClient ---
        CloseableHttpClient client = HttpClients.custom()
                .setConnectionManager(cm)
                .build();

        // --- Prepare POST request ---
        HttpPost post = new HttpPost("https://your-api-server/endpoint");

        post.setEntity(new StringEntity("{\"msg\":\"hello\"}", "UTF-8"));
        post.setHeader("Content-Type", "application/json");

        // --- Execute request ---
        try (CloseableHttpResponse response = client.execute(post)) {
            System.out.println("Status: " + response.getCode());
            System.out.println("Response: " + response.getEntity());
        }
    }
}
